<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.2.5">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Matthew Turk">

  
  
  
    
  
  <meta name="description" content="I think I&#39;ve talked myself into proposing a big change in yt. I&#39;m not the &ldquo;boss&rdquo; of yt, so it might not happen, but I&#39;ve kind of worked up my courage to make a serious suggestion.
This last week I have been at SciPy 2019 and I had the opportunity to see a lot of talks.
There were a few that really stuck with me, but for the purposes of this rather technically-focused blog post, I&#39;m going to stick to just one in particular.">

  
  <link rel="alternate" hreflang="en-us" href="https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#EF525B">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono">
  

  
  
  
  <link rel="stylesheet" href="/css/academic.min.331f53d055a276ccbdada146254dc48b.css">

  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-141183895-1', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/">

  
  
  
  
    
    
  
  <meta property="twitter:card" content="summary">
  
  <meta property="twitter:site" content="@powersoffour">
  <meta property="twitter:creator" content="@powersoffour">
  
  <meta property="og:site_name" content="mjt">
  <meta property="og:url" content="https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/">
  <meta property="og:title" content="yt: Internal and External Ecosystems | mjt">
  <meta property="og:description" content="I think I&#39;ve talked myself into proposing a big change in yt. I&#39;m not the &ldquo;boss&rdquo; of yt, so it might not happen, but I&#39;ve kind of worked up my courage to make a serious suggestion.
This last week I have been at SciPy 2019 and I had the opportunity to see a lot of talks.
There were a few that really stuck with me, but for the purposes of this rather technically-focused blog post, I&#39;m going to stick to just one in particular."><meta property="og:image" content="https://matthewturk.github.io/img/icon-192.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-07-16T14:28:36-05:00">
  
  <meta property="article:modified_time" content="2019-07-16T14:31:52-05:00">
  

  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#EF525B",
          "text": "#EAE7D6"
        },
        "button": {
          "background": "#EAE7D6",
          "text": "#EF525B"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://cookies.insites.com"
      }
    })});
</script>


  

  <title>yt: Internal and External Ecosystems | mjt</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" role="textbox" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">mjt</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#projects">
            
            <span>Projects</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#courses">
            
            <span>Courses</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#talks">
            
            <span>Talks</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#publications">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
            
          
        

        <li class="nav-item">
          <a class="nav-link" href="https://data-exp-lab.github.io/" target="_blank" rel="noopener">
            
            <span>Research Group</span>
            
          </a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1 itemprop="name">yt: Internal and External Ecosystems</h1>

  

  
    



<meta content="2019-07-16 14:28:36 -0500 CDT" itemprop="datePublished">
<meta content="2019-07-16 14:31:52 -0500 CDT" itemprop="dateModified">

<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
          Last updated on
      
    
    <time>Jul 16, 2019</time>
  </span>
  

  

  

  
  

  
  

  
    

  

</div>

    








  









  
</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <p>I think I've talked myself into proposing a big change in yt.  I'm not the &ldquo;boss&rdquo; of yt, so it might not happen, but I've kind of worked up my courage to make a serious suggestion.</p>
<p>This last week I have been at <a href="https://scipy2019.scipy.org/">SciPy 2019</a> and I had the opportunity to see a lot of talks.</p>
<p>There were a few that really stuck with me, but for the purposes of this rather technically-focused blog post, I'm going to stick to just one in particular.</p>
<p><a href="http://matthewrocklin.com/">Matt Rocklin</a> gave a talk about <a href="https://www.youtube.com/watch?v=Q0DsdiY-jiw">refactoring the ecosystem to prepare for heterogeneous computing</a>  (you should go watch it!).  More specifically, though, what it seemed to me was that it was a talk more about an opportunity to avoid fragmentation and think more carefully about how arrays and APIs are thought of and used.  That got me thinking about something I've kind of touched on in previous posts (<a href="https://matthewturk.github.io/post/refactoring-yt-frontends-part1/">here</a>, <a href="https://matthewturk.github.io/post/refactoring-yt-frontends-part2/">here</a> and <a href="https://matthewturk.github.io/post/refactoring-yt-frontends-part3/">here</a>) &ndash; basically, that yt is pretty monolithic, and that's not really the best way to evolve with the ecosystem.</p>
<p>I'll be using <a href="https://github.com/mgedmin/findimports">findimports</a> for exploring how monolithic it <em>is</em> versus how monolithic it <em>appears to be</em>.  Basically, I want to see: is it one repo with lots of interconnections, or is it essentially a couple repos?</p>
<p>(Also at the end I'll give a pitch for why this is relevant, so if you're even remotely intrigued, at <em>least</em> scroll down to the section labeled &ldquo;OK, the boring stuff is over.&quot;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pickle
<span style="color:#f92672">import</span> findimports
yt_imports <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>load(open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt/yt/import_output.pkl</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">rb</span><span style="color:#e6db74">&#34;</span>))
</code></pre></div><p>The structure of this is a set of keys that are strings of the filename/modulename, with values that are the objects in question.  The <code>findimports</code> objects have an attribute <code>imports</code> which is what we're going to look at first, but they also have an <code>imported_names</code> attribute which is the list of names that get imported, in the form of <code>ImportInfo</code> objects.  These have <code>name</code>, <code>filename</code>, <code>level</code> and <code>lineno</code> to show where and what they are.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">yt_imports[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">yt.visualization.plot_window</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>imports
</code></pre></div><pre><code>{'collections',
 'distutils.version',
 'matplotlib',
 'matplotlib.mathtext',
 'matplotlib.ticker',
 'numbers',
 'numpy',
 'pyparsing',
 'sys',
 'types',
 'unyt.exceptions',
 'yt',
 'yt.data_objects.image_array',
 'yt.frontends.ytdata.data_structures',
 'yt.funcs',
 'yt.units.unit_object',
 'yt.units.unit_registry',
 'yt.units.yt_array',
 'yt.utilities.exceptions',
 'yt.utilities.math_utils',
 'yt.utilities.orientation',
 'yt.visualization.base_plot_types',
 'yt.visualization.fixed_resolution',
 'yt.visualization.geo_plot_utils',
 'yt.visualization.plot_container',
 'yt.visualization.plot_modifications'}
</code></pre>
<p>There happen to be a fair number of things in here that are external to yt!  So, let's set up a filtering process for those.  We'll filter the <code>name</code> that is imported.</p>
<p>One thing I should note is that yt does many, but not <em>all</em>, of its imports in absolute form, which maybe isn't &hellip; so great &hellip; but which lets us do this more easily.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">filter_imports <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> a: [_ <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> sorted(a, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> b: b<span style="color:#f92672">.</span>name) <span style="color:#66d9ef">if</span> _<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.</span><span style="color:#e6db74">&#34;</span>)]
</code></pre></div><p>We'll apply it to the <code>imported_names</code> attribute, since we're interested in characterizing how things are related and interweaved.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">import_lists <span style="color:#f92672">=</span> {_ : filter_imports(yt_imports[_]<span style="color:#f92672">.</span>imported_names) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> yt_imports}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">import_lists[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">yt.visualization.plot_window</span><span style="color:#e6db74">&#39;</span>]
</code></pre></div><pre><code>[ImportInfo('yt.data_objects.image_array.ImageArray', 'yt/visualization/plot_window.py', 40, 0),
 ImportInfo('yt.frontends.ytdata.data_structures.YTSpatialPlotDataset', 'yt/visualization/plot_window.py', 42, 0),
 ImportInfo('yt.funcs.ensure_list', 'yt/visualization/plot_window.py', 44, 0),
 ImportInfo('yt.funcs.fix_axis', 'yt/visualization/plot_window.py', 45, 0),
 ImportInfo('yt.funcs.fix_unitary', 'yt/visualization/plot_window.py', 45, 0),
 ImportInfo('yt.funcs.iterable', 'yt/visualization/plot_window.py', 44, 0),
 ImportInfo('yt.funcs.mylog', 'yt/visualization/plot_window.py', 44, 0),
 ImportInfo('yt.funcs.obj_length', 'yt/visualization/plot_window.py', 45, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 737, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 1373, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 1557, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 2067, 0),
 ImportInfo('yt.units.unit_object.Unit', 'yt/visualization/plot_window.py', 47, 0),
 ImportInfo('yt.units.unit_registry.UnitParseError', 'yt/visualization/plot_window.py', 49, 0),
 ImportInfo('yt.units.yt_array.YTArray', 'yt/visualization/plot_window.py', 51, 0),
 ImportInfo('yt.units.yt_array.YTQuantity', 'yt/visualization/plot_window.py', 51, 0),
 ImportInfo('yt.utilities.exceptions.YTCannotParseUnitDisplayName', 'yt/visualization/plot_window.py', 57, 0),
 ImportInfo('yt.utilities.exceptions.YTDataTypeUnsupported', 'yt/visualization/plot_window.py', 59, 0),
 ImportInfo('yt.utilities.exceptions.YTInvalidFieldType', 'yt/visualization/plot_window.py', 60, 0),
 ImportInfo('yt.utilities.exceptions.YTPlotCallbackError', 'yt/visualization/plot_window.py', 58, 0),
 ImportInfo('yt.utilities.exceptions.YTUnitNotRecognized', 'yt/visualization/plot_window.py', 61, 0),
 ImportInfo('yt.utilities.math_utils.ortho_find', 'yt/visualization/plot_window.py', 53, 0),
 ImportInfo('yt.utilities.orientation.Orientation', 'yt/visualization/plot_window.py', 55, 0)]
</code></pre>
<p>This still isn't <em>incredibly</em> useful, since we kind of want to look at imports at a higher level.  For instance, I want to know what <code>yt.visualization.plot_window</code> imports from in the broad cross-section of the code base.  So let's write something to collapse the package <em>under</em> yt that we import from.  We used <code>startswith(&quot;.yt&quot;)</code> earlier, so it'll be safe to do a split here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">collapse_subpackage <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> a: set(_<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> a)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">collapse_subpackage(import_lists[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">yt.visualization.plot_window</span><span style="color:#e6db74">&#39;</span>])
</code></pre></div><pre><code>{'data_objects', 'frontends', 'funcs', 'load', 'units', 'utilities'}
</code></pre>
<p>Interesting.  We import from frontends?!  I guess I kind of missed that earlier.  Let's see if we can figure out the connections between different modules to see if anything stands out.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">subpackage_imports <span style="color:#f92672">=</span> defaultdict(set)
<span style="color:#66d9ef">for</span> fn, v <span style="color:#f92672">in</span> import_lists<span style="color:#f92672">.</span>items():
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> fn<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.</span><span style="color:#e6db74">&#34;</span>): <span style="color:#66d9ef">continue</span> <span style="color:#75715e"># Get rid of our tests, etc.</span>
    subpackage <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>]
    subpackage_imports[subpackage]<span style="color:#f92672">.</span>update(collapse_subpackage(v))
</code></pre></div><p>Let's break this down before we go any further &ndash; for starters, not <em>everything</em> is an absolute import.  So that makes things a bit tricky!  But we can deal with that later.  Let's first see what all we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">subpackage_imports<span style="color:#f92672">.</span>keys()
</code></pre></div><pre><code>dict_keys(['__init__', 'api', 'arraytypes', 'config', 'convenience', 'exthook', 'funcs', 'mods', 'pmods', 'startup_tasks', 'testing', 'analysis_modules', 'data_objects', 'extensions', 'extern', 'fields', 'frontends', 'geometry', 'tests', 'units', 'utilities', 'visualization'])
</code></pre>
<p>A few things stand out right away.  Some of these we can immediately get rid of and not consider.  For instance, <code>pmods</code> is an MPI-aware importer, <code>mods</code> is a pretty old-school approach to yt importing, and we will just ignore <code>testing</code>, <code>analysis_modules</code>, <code>extensions</code> and <code>extern</code> since they're (in order) testing utilities, gone, a fake hook system, and &ldquo;vendored&rdquo; libraries that we should probably get rid of and just make requirements anyway.  <code>units</code> is now part of <a href="https://github.com/yt-project/unyt"><code>unyt</code></a> and some of the others are by-design grabbing lots of stuff.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">blacklist <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">testing</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">analysis_modules</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">extensions</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">extern</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pmods</span><span style="color:#e6db74">&#34;</span>,
             <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">mods</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__init__</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">api</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">arraytypes</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">config</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">convenience</span><span style="color:#e6db74">&#34;</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">exthook</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">funcs</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tests</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">units</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">startup_tasks</span><span style="color:#e6db74">&#34;</span>]

list(subpackage_imports<span style="color:#f92672">.</span>pop(_, None) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> blacklist);
</code></pre></div><p>We just want to see the interrelationships, so we'll look for N-by-N collisions, where N is just the values that show up as keys.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">collide_with <span style="color:#f92672">=</span> set(subpackage_imports<span style="color:#f92672">.</span>keys())
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">collisions <span style="color:#f92672">=</span> {_: collide_with<span style="color:#f92672">.</span>intersection(subpackage_imports[_]) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> subpackage_imports}
</code></pre></div><p>And here we have it, the moment of truth!  What do we see &hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>({_:len(__) <span style="color:#66d9ef">for</span> _, __ <span style="color:#f92672">in</span> collisions<span style="color:#f92672">.</span>items()})
</code></pre></div><pre><code>{'data_objects': 6, 'fields': 5, 'frontends': 6, 'geometry': 5, 'utilities': 6, 'visualization': 6}
</code></pre>
<p>Huh.  Well, that was not the dramatic, amazing reveal I'd hoped for.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">subpackage_imports <span style="color:#f92672">=</span> defaultdict(set)
<span style="color:#66d9ef">for</span> fn, v <span style="color:#f92672">in</span> import_lists<span style="color:#f92672">.</span>items():
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> fn<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tests</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">in</span> fn: <span style="color:#66d9ef">continue</span> <span style="color:#75715e"># Get rid of our tests, etc.</span>
    subpackage <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>]
    subpackage_imports[subpackage]<span style="color:#f92672">.</span>update(collapse_subpackage(v))
list(subpackage_imports<span style="color:#f92672">.</span>pop(_, None) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> blacklist);
collisions <span style="color:#f92672">=</span> {_: collide_with<span style="color:#f92672">.</span>intersection(subpackage_imports[_]) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> subpackage_imports}
<span style="color:#66d9ef">print</span>({_:len(__) <span style="color:#66d9ef">for</span> _, __ <span style="color:#f92672">in</span> collisions<span style="color:#f92672">.</span>items()})
</code></pre></div><pre><code>{'data_objects': 6, 'fields': 4, 'frontends': 6, 'geometry': 4, 'utilities': 5, 'visualization': 6}
</code></pre>
<p>It gets a little bit better, but honestly, not much.  Our most isolated package &ndash; by this (likely flawed) method &ndash; are the <code>geometry</code> and <code>fields</code> packages.  So let's break down a bit more what we're seeing, by not filtering quite as much, and by setting up a reverse mapping.  And let's do it for both the collapsed name and the non-collapsed name.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">subpackage_imports <span style="color:#f92672">=</span> defaultdict(set)
imported_by <span style="color:#f92672">=</span> defaultdict(list)
<span style="color:#66d9ef">for</span> fn, v <span style="color:#f92672">in</span> import_lists<span style="color:#f92672">.</span>items():
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> fn<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.</span><span style="color:#e6db74">&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tests</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">in</span> fn: <span style="color:#66d9ef">continue</span> <span style="color:#75715e"># Get rid of our tests, etc.</span>
    subpackage <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">.</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#ae81ff">1</span>]
    subpackage_imports[subpackage]<span style="color:#f92672">.</span>update(set(_<span style="color:#f92672">.</span>name <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> v))
    [imported_by[_<span style="color:#f92672">.</span>name]<span style="color:#f92672">.</span>append(fn) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> v]
    [imported_by[_]<span style="color:#f92672">.</span>append(fn) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> collapse_subpackage(v)]
</code></pre></div><p>And now we might be getting somewhere.  So now we can look up for any given import which files have imported it.  Let's see what imports the progress bar:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">imported_by[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.funcs.get_pbar</span><span style="color:#e6db74">&#34;</span>]
</code></pre></div><pre><code>['yt.__init__',
 'yt.data_objects.particle_trajectories',
 'yt.data_objects.level_sets.contour_finder',
 'yt.frontends.athena_pp.data_structures',
 'yt.frontends.enzo.data_structures',
 'yt.frontends.enzo_p.data_structures',
 'yt.geometry.particle_geometry_handler',
 'yt.utilities.minimal_representation',
 'yt.utilities.particle_generator',
 'yt.utilities.answer_testing.framework',
 'yt.visualization.streamlines',
 'yt.visualization.volume_rendering.old_camera']
</code></pre>
<p>Nice.  Now, let's look at visualization.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">imported_by[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.visualization.api.SlicePlot</span><span style="color:#e6db74">&#34;</span>], imported_by[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.visualization.plot_window.SlicePlot</span><span style="color:#e6db74">&#34;</span>]
</code></pre></div><pre><code>(['yt.__init__', 'yt.data_objects.analyzer_objects'],
 ['yt.utilities.command_line'])
</code></pre>
<p>We're starting to see that things might not be quite as clear-cut as we thought.  Let's look at geometry.  And I'm going to set up a filtering method so that we can avoid lots of redundant pieces of info &ndash; for instance, I don't care about things importing themselves.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">filter_self_imports <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> a: [_ <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> imported_by[a] <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> _<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">yt.{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(a))]
</code></pre></div><p>We'll only look at the first ten, because it's really long&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">filter_self_imports(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">geometry</span><span style="color:#e6db74">&#34;</span>)[:<span style="color:#ae81ff">10</span>]
</code></pre></div><pre><code>['yt.data_objects.construction_data_containers',
 'yt.data_objects.data_containers',
 'yt.data_objects.grid_patch',
 'yt.data_objects.octree_subset',
 'yt.data_objects.selection_data_containers',
 'yt.data_objects.static_output',
 'yt.data_objects.unstructured_mesh',
 'yt.frontends._skeleton.data_structures',
 'yt.frontends.ahf.data_structures',
 'yt.frontends.art.data_structures']
</code></pre>
<p>Here things are <em>much</em> clearer.  We import geometry <em>once</em> in the visualization subsystem, under <code>plot_modifications</code>.  I looked it up, and here's what it is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> issubclass(type(index), UnstructuredIndex):
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Mesh line annotations only work for </span><span style="color:#e6db74">&#34;</span>
                        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unstructured or semi-structured mesh data.</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>This is probably an anti-pattern, but even if we wanted to retain this specific behavior, we could remedy it without too much trouble by having an attribute check, or some kind of string-key check.</p>
<p>As for all the <code>frontends</code> imports, those are all because they subclass <code>Index</code>!  And many of the places importing it in <code>data_objects</code> are just due to a lack of organization in the geometry/utilities/indexing code.</p>
<p><strong>Historical Sidenote</strong>: As I was doing this, I read the header for <code>grid_patch.py</code> and it reads: <code>&quot;Python-based grid handler, not to be confused with the SWIG-handler&quot;</code>.  I am reasonably certain that it has been <em>years</em> since I thought about the proto-SWIG system I'd written to wrap around the Enzo C++ code.  Kinda supports the point I intend to make when I end this post, I think.</p>
<p>Back to the task at hand, let's look at some of the other top-level packages and how they related.  I'm now specifically interested in the <code>visualization</code> and <code>data_objects</code> ones.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">filter_self_imports(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">visualization</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><pre><code>['yt.__init__',
 'yt.data_objects.analyzer_objects',
 'yt.data_objects.construction_data_containers',
 'yt.data_objects.data_containers',
 'yt.data_objects.image_array',
 'yt.data_objects.profiles',
 'yt.data_objects.region_expression',
 'yt.data_objects.selection_data_containers',
 'yt.frontends.fits.misc',
 'yt.utilities.command_line',
 'yt.utilities.fits_image',
 'yt.utilities.answer_testing.framework']
</code></pre>
<p>Well, that's interesting.  A quick skim of the code suggests that <code>analyzer_objects</code> is probably dead code to be removed, <code>construction_data_containers</code> imports viz so that <code>.plot()</code> will work on projections, and there are a handful of other data-object-to-viz things that get done here.</p>
<p>In short, I'm pretty sure that <code>visualization</code> is a mostly independent subpackage.  And the same kind of goes for <code>geometry</code>.  The story isn't quite as clear for the others.</p>
<h2 id="ok-the-boring-stuff-is-over">OK, the boring stuff is over.</h2>
<p>Here's where I wanted to get this whole time: yt is a monolithic package in packaging, but it also has a couple reasonably independent sub-packages within it.  It <em>would</em> be a target for breaking up, <em>if</em> those subpackages were independently useful.  But as it stands, they probably aren't, since they're all very tightly coupled.</p>
<p>They're coupled because they were written that way, without too much thought given to a public, externally-useful API.  This is something that's probably not surprising, since yt was a big package that evolved, rather than many packages that interoperated.  Lots of stuff we wanted didn't exist, and there was (we thought) really only one obvious way to do things, so why not just do it?</p>
<p>(<strong>Historical sidenote</strong>: It was a few years ago that I remember asking at a panel what middleware developers, like I saw myself, were supposed to do in a rapidly evolving ecosystem of the array container.  (I probably didn't phrase it very well.)  What I took away was: stick with numpy.  And we did stick with numpy, and more importantly, we <em>stuck with the Cython interface to numpy</em>.)</p>
<h2 id="ok-no-more-rambling-get-to-the-point">OK, no more rambling, get to the point</h2>
<p>yt did a lot of stuff on its own.  It doesn't need to anymore.  It's effectively a medium-ly coupled system, but one that has relied on the ability to change non-public APIs all the time.</p>
<p>I'm starting to convince myself it's time to mature as a project, and to do some combination of <em>jettisoning</em> and <em>liberating</em> things in yt.  I'll make it clear that I could be wrong on this, and seeing this through will probably take more thought, time and energy than I can reasonably personally commit, but I think I've started to see what would be a productive path forward.</p>
<h1 id="steps-to-integrate-better">Steps to Integrate Better</h1>
<p>Here are some things that I think yt could do.  These are my thoughts, which I have <em>not</em> presented to the steering council, written up in a YTEP, or even made any efforts toward.  In fact, the one member of the steering committee to whom I said, &ldquo;I think I might blog about this&rdquo; explicitly suggested I not do that thing (blog)!  But here I am a couple pages deep and I've always been a bit of a hoarder.</p>
<h3 id="inventory">Inventory</h3>
<p>The first step would be to take a real inventory of what is in yt, and what ought to be in yt.  I have some thoughts on things that could be gotten rid of (and I will happily note that I intend to &ldquo;kill my own darlings&rdquo; first, before anyone else's) but that can come later.</p>
<p>Not everything yt does needs to be done <em>by yt</em>.  But before we can figure that out, let's figure out what yt is doing, and where it gets relied on.</p>
<h3 id="indexing">Indexing</h3>
<p>The thing I think we absolutely need to think about is how tightly coupled the indexing system is with everything else.  This will almost certainly be a full blog post at a later time, but the way the indexing is coupled so tightly with the frontends makes me increasingly leery.</p>
<p>I personally think that the way the grid indexing is set up is too fixed on a pre-parsing step and a finalization step, with lots of little bits in between that need to be handled, and that it could much more easily be set up with a different procedure.</p>
<p>For the particle frontends, the particle bitmap indexing has the filenames and the particle types and the coordinates and <em>all</em> of that all wound together.  This should be decoupled, so that the notion of the particle locations is held at a higher level than the bitmap indexing.</p>
<h3 id="consider-splitting-the-package">Consider Splitting the Package</h3>
<p>This one &hellip; I want to emphasize that what I think we should do is the process of considering it.  I'm not sure that it should be split.  But I think that evaluating the pros and cons will lead us to think about <em>how</em> our packages interact.</p>
<p>If two objects call weird methods on each other, why?  Does that need to happen?  Is it a micro-optimization that makes no sense other than obfuscation?  I'm not sure, but we can't figure it out unless we examine.</p>
<h1 id="big-picture">Big Picture</h1>
<p>yt may stay a big repository, but if we reduce the dependence on artisanal objects (why not just subclass <code>xarray.Dataset</code> instead of have a <code>GridPatch</code> object?  Well, okay, that one is pretty complicated, but we can talk about it later&hellip;) and we think about the specifics of why we use public APIs versus private APIs, it can lead to a more robust, lightweight package.</p>
<p>And anything that keeps us more lightweight, reduces maintenance burdens, and enables us to take advantage of the astounding advances in the ecosystem is probably going to be better in the long-run.</p>

    </div>

    



    
      

      
      
    

    

    


  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
        
      

      
      
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.ee93f50e7bcdd181a29c10939fba4467.js"></script>

  </body>
</html>

